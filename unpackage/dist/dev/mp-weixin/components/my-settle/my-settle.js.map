{"version":3,"file":"my-settle.js","sources":["../../../../../../components/my-settle/my-settle.vue","../../../../../../../../../../Applications/HBuilderX.app/Contents/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/L1VzZXJzL3lhbmd5b25ncWlhbi9jb2RlL3VuaS1zaG9wL2NvbXBvbmVudHMvbXktc2V0dGxlL215LXNldHRsZS52dWU"],"sourcesContent":["<template>\n\t<view class=\"my-settle-container\">\n\t\t<!-- 全选区域 -->\n\t\t<label class=\"radio\" @click=\"changeState\">\n\t\t\t<radio color=\"#c00000\" :checked=\"isFullChecked\" />\n\t\t\t<text>全选</text>\n\t\t</label>\n\t\t<!-- 合计区域 -->\n\t\t<view class=\"amount-box\">\n\t\t\t合计:\n\t\t\t<text class=\"amount\">￥{{ checkedGoodsAmount }}</text>\n\t\t</view>\n\t\t<!-- 结算区域 -->\n\t\t<view class=\"btn-settle\" @click=\"settlement\">结算({{ checkedCount }})</view>\n\t</view>\n</template>\n\n<script setup>\nimport { ref, computed } from 'vue';\nimport { useStore } from 'vuex';\nconst store = useStore();\nconst allCount = computed(() => store.getters['m_cart/allCount']);\nconst checkedCount = computed(() => store.getters['m_cart/checkedCount']);\nconst isFullChecked = computed(() => allCount.value === checkedCount.value);\nconst changeState = () => store.commit('m_cart/updateAllGoodsState', !isFullChecked.value);\n\nconst addstr = computed(() => store.getters['m_user/addstr']);\nconst token = computed(() => store.state['m_user'].token);\n// 用户结算\nconst settlement = () => {\n\tif (!checkedCount.value) return uni.$showMessage('请先勾选商品');\n\tif (!addstr.value) return uni.$showMessage('请先选择地址');\n\tif (!token.value) return delayNavigation();\n\t// 支付订单\n\tpayOrder();\n};\n\nconst seconds = ref(3);\nconst timer = ref(null);\n// 延迟跳转到我的页面\nconst delayNavigation = () => {\n\tshowTips(seconds.value);\n\ttimer.value = setInterval(() => {\n\t\tseconds.value--;\n\t\t// 添加定时器边界\n\t\tif (seconds.value <= 0) {\n\t\t\tclearInterval(timer.value);\n\t\t\tuni.switchTab({\n\t\t\t\turl: '/pages/my/my',\n\t\t\t\tsuccess: () => {\n\t\t\t\t\tstore.commit('m_user/updateRedirectInfo', {\n\t\t\t\t\t\topenType: 'switchTab',\n\t\t\t\t\t\tfrom: '/pages/cart/cart'\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\t\tshowTips(seconds.value);\n\t}, 1000);\n};\nconst showTips = n => {\n\tuni.showToast({\n\t\ttitle: `请登录后再结算，${n}秒之后将跳转登录页面`,\n\t\ticon: 'none',\n\t\tmask: true, // 添加遮罩层，防止点击穿透\n\t\tduration: 1500\n\t});\n};\n\nconst checkedGoodsAmount = computed(() => store.getters['m_cart/checkedGoodsAmount']);\n// 订单支付\nconst payOrder = async () => {\n\t// 1.创建订单\n\tconst cartResult = computed(() => store.state['m_cart'].cart);\n\tconst goods = cartResult.value\n\t\t.filter(t => t.goods_state)\n\t\t.map(s => {\n\t\t\treturn {\n\t\t\t\tgoods_id: s.goods_id,\n\t\t\t\tgoods_number: s.goods_count,\n\t\t\t\tgoods_price: s.goods_price\n\t\t\t};\n\t\t});\n\t//1.1 组建订单信息对象\n\tconst orderInfo = {\n\t\t// order_price: checkedGoodsAmount\n\t\torder_price: '0.01',\n\t\tconsignee_addr: addstr.value,\n\t\tgoods\n\t};\n\t//1.2 发起网络请求\n\tconst { data } = await uni.$http.post('/api/public/v1/my/orders/create', orderInfo);\n\tconst { meta, message } = data;\n\tif (meta.status !== 200) return uni.$showMessage('创建订单失败');\n\t//1.3 获取订单编号\n\tconst orderNum = message.order_number;\n\t// 2.订单预支付 参数：订单编号 =>返回微信支付需要的参数\n\t//2.1 发起订单预支付的请求\n\tconst { data: prepayment } = await uni.$http.post('/api/public/v1/my/orders/req_unifiedorder', orderNum);\n\tconst { meta: prepaymentMeta, message: prepaymentMessage } = prepayment;\n\tif (prepaymentMeta?.status !== 200) return uni.$showMessage('创建订单失败');\n\tconst payInfo = prepaymentMessage.pay;\n\n\t// 3.发起微信支付 调用 uni.requestPayment() 发起微信支付\n\tuni.requestPayment({\n\t\t...payInfo,\n\t\tsuccess: async res => {\n\t\t\t// 3.3 完成了支付，进一步查询支付的结果\n\t\t\tconst { data: res3 } = await uni.$http.post('/api/public/v1/my/orders/chkOrder', { order_number: orderNum });\n\t\t\tif (res3.meta.status !== 200) return uni.$showMessage('订单未支付！');\n\t\t\t// 3.5 检测到订单支付完成\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '支付完成！',\n\t\t\t\ticon: 'success'\n\t\t\t});\n\t\t},\n\t\tfail: err => {\n\t\t\t// 3.4 检测到订单未支付\n\t\t\treturn uni.$showMessage('订单未支付！');\n\t\t}\n\t});\n};\n</script>\n\n<style lang=\"scss\">\n.my-settle-container {\n\tposition: fixed;\n\tbottom: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 50px;\n\tbackground-color: white;\n\tdisplay: flex;\n\tjustify-content: space-between;\n\talign-items: center;\n\tfont-size: 14px;\n\tpadding-left: 5px;\n\t.radio {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t}\n\t.amount-box {\n\t\t.amount {\n\t\t\tcolor: #c00000;\n\t\t\tfont-weight: bold;\n\t\t}\n\t}\n\t.btn-settle {\n\t\theight: 50px;\n\t\tbackground: #c00000;\n\t\tcolor: #fff;\n\t\tline-height: 50px;\n\t\tpadding: 0 10px;\n\t\tmin-width: 100px;\n\t\ttext-align: center;\n\t}\n}\n</style>\n","import Component from '/Users/yangyongqian/code/uni-shop/components/my-settle/my-settle.vue'\nwx.createComponent(Component)"],"names":["useStore","computed","uni","ref"],"mappings":"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"}